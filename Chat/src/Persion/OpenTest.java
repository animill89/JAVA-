package Persion;

import java.awt.TextArea;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.EOFException;
import java.io.IOException;
import java.net.SocketException;

import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;

import Servercliet.OutPut;

public class OpenTest extends JFrame implements Runnable {

	private static final long serialVersionUID = 1720361181828968073L;
	private TextArea tfTxt =new TextArea();
	private JLabel content = new JLabel("聊天记录....");
	private TextArea taContent=new TextArea();
	private JLabel list = new JLabel("当前在线用户列表....");
	private TextArea talkList = new TextArea();
	private DataOutputStream dos;
	private DataInputStream dis;
	private boolean beConnected;
	
	public OpenTest(DataInputStream dis, DataOutputStream dos) {
		this.dis = dis;
		this.dos = dos;
		this.beConnected = true;
	}
	/**
	 * 启动聊天主窗口
	 */
	public void launchFrame() {
		this.setTitle("聊天室登陆窗口");
		setBounds(100,100,650,600);
		this.setLayout(null);
		list.setBounds(50, 30, 200, 20);
		this.add(list);
		talkList.setBounds(10, 70, 170, 400);
		this.add(talkList);
		content.setBounds(250, 30, 200, 20);
		this.add(content);
		taContent.setBounds(220, 70, 400, 400);
		this.add(taContent);
		tfTxt.setBounds(10, 480, 600, 100);
		this.add(tfTxt);
		setVisible(true);
		this.addWindowListener(new WindowAdapter(){
			public void windowClosing(WindowEvent e){
				try {
					beConnected = false;
					dis.close();
					dos.close();
				} catch (IOException e1) {
					e1.printStackTrace();
				}
				e.getWindow().dispose();
				System.exit(0);
			}
		});
		tfTxt.addKeyListener(new Liever(tfTxt, dos));
	}

	public void run() {
		try{
			while (beConnected){
				String str=dis.readUTF();//读取服务器的信息
				if (str.length() >= OutPut.USER_LIST.length() && str.substring(0, OutPut.USER_LIST.length()).equals(OutPut.USER_LIST)) {
					String userList = str.substring(OutPut.USER_LIST.length());//更新用户列表
					talkList.setText(userList);
				} else {
					taContent.setText(taContent.getText()+str+'\n');//更新聊天内容
				}
			}
		} catch (SocketException e) {
			this.showReturnMessage("连接断开，请检查你的网络情况.....");
		} catch (EOFException e) {
			this.showReturnMessage("连接断开，请检查你的网络情况.....");
		} catch(IOException e){
			this.showReturnMessage("未知IO错误，请重新再试试，不行马上与管理员联系！");
		} 
	}
	
	/**
	 *  显示反馈信息
	 */
	public void showReturnMessage(String message) {
		JOptionPane.showMessageDialog(null, message, OutPut.ERROR_TITLE, JOptionPane.ERROR_MESSAGE);
	}
}
